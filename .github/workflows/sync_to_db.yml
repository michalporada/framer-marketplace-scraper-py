name: Sync JSON to Database

on:
  workflow_dispatch:  # Ręczne uruchomienie
  schedule:
    - cron: '0 3 * * *'  # Codziennie o 3:00 UTC (po scrapowaniu o 2:00)

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download artifacts (if available)
        id: download-artifacts
        uses: actions/download-artifact@v4
        with:
          name: scraped-data-latest
          path: data/
          if-no-files-found: continue
      
      - name: Check if artifact was downloaded
        run: |
          if [ "${{ steps.download-artifacts.outcome }}" != "success" ]; then
            echo "⚠️ Artifact 'scraped-data-latest' not found or empty"
            echo "This may happen if:"
            echo "  - Scrape workflow hasn't run yet"
            echo "  - Scrape workflow failed"
            echo "  - Artifact expired (retention: 7 days)"
            exit 1
          else
            echo "✅ Artifact downloaded successfully"
          fi
      
      - name: Check if data exists
        run: |
          if [ ! -d "data/products" ] || [ -z "$(ls -A data/products/*/*.json 2>/dev/null)" ]; then
            echo "⚠️ No JSON data found in artifact. Make sure data/ directory exists with scraped data."
            echo "Available directories:"
            ls -la data/ 2>/dev/null || echo "data/ directory not found"
            echo "Checking for product files:"
            find data/ -name "*.json" -type f 2>/dev/null | head -10 || echo "No JSON files found"
            exit 1
          else
            echo "✅ Found JSON data files"
            find data/products -name "*.json" | wc -l | xargs echo "Total product files:"
          fi
      
      - name: Sync JSON to Database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "⚠️ DATABASE_URL not set in secrets. Skipping sync."
            exit 0
          fi
          python scripts/sync_json_to_db.py
      
      - name: Upload sync logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs
          path: logs/
          retention-days: 7

